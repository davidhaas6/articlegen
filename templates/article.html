{% extends "base.html" %}

{% block title %}{{title}} - RNN{% endblock %}

{% block extra_head %}
<meta property="og:title" content="{{ title|safe }}">
<meta property="og:description" content="{{ overview|safe }}">
<meta property="og:image" content="{{ 'https://ratnewsnetwork.com/static/img/' + img_path }}">
<meta property="og:type" content="article">
{% endblock %}

{% block content %}
<div class="container content">
    <h1>{{ title }}</h1>
    <div class="overview">{{ overview|safe }}</div>
    <span class="read-time">
        {{reading_time}} minute read •
        <a href="#comments-section" id="scroll-to-comments" class="comments-link">Comments</a>
        {% if parody_src != None %}
            <span> • </span><a href="{{parody_src}}" class="comments-link">Source Article</a>
        {% endif %}
    </span>
    {% if img_path != None %}
    <img src="/static/img/{{img_path}}" alt="article image">
    {% endif %}
    <br>
    <div class="article-container">
        <span class="article-body">
            {{ body|safe }}
            <br>
            <br>
            <br>
            <i>Looking for more in-depth news and exclusive content? Follow <a
                    href="https://tiktok.com/@ratnewsnetwork">RAT TV</a> for real-time updates, behind-the-scenes
                insights and the latest breaking news.</i>
        </span>
    </div>
    {% if comments|length > 0 %}
    <div id="comments-section" class="article-comments">
        <h1>Comments</h1>
        {% for comment in comments %}
        <div class="comment">
            <div class="comment-author">{{comment.username}}</div>
            <div class="comment-body">{{comment.text}}</div>
            <div class="votes">
                <button class="vote-up-count">+{{comment.upvotes}}</button>
                <button class="vote-down-count">-{{comment.downvotes}}</button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
</div>

<script>
    // Helper to update the vote count on a button.
    function updateVoteText(button, prefix, diff) {
        const currentCount = parseInt(button.textContent.replace(prefix, ''));
        button.textContent = prefix + (currentCount + diff);
    }

    // Handler for a vote click.
    // currentButton: The button that was clicked.
    // oppositeButton: The other vote button for the same comment.
    // prefix: '+' for upvotes, '-' for downvotes.
    function handleVoteClick(currentButton, oppositeButton, prefix) {
        if (currentButton.classList.contains('clicked')) {
            // If already clicked, remove the vote.
            updateVoteText(currentButton, prefix, -1);
            currentButton.classList.remove('clicked');
        } else {
            // If the opposite button is active, remove its vote.
            if (oppositeButton.classList.contains('clicked')) {
                const oppositePrefix = prefix === '+' ? '-' : '+';
                updateVoteText(oppositeButton, oppositePrefix, -1);
                oppositeButton.classList.remove('clicked');
            }
            // Add the vote for the current button.
            updateVoteText(currentButton, prefix, 1);
            currentButton.classList.add('clicked');
        }
    }

    // Set up voting for a single comment.
    function setupCommentVoting(comment) {
        const upvoteBtn = comment.querySelector('.vote-up-count');
        const downvoteBtn = comment.querySelector('.vote-down-count');

        upvoteBtn.addEventListener('click', () => {
            handleVoteClick(upvoteBtn, downvoteBtn, '+');
        });
        downvoteBtn.addEventListener('click', () => {
            handleVoteClick(downvoteBtn, upvoteBtn, '-');
        });
    }

    // Iterate through each comment container and set up voting.
    document.querySelectorAll('.comment').forEach(setupCommentVoting);

    // smooth scrolling
    document.getElementById('scroll-to-comments').addEventListener('click', function (e) {
        e.preventDefault(); // Prevent the default link behavior
        document.getElementById('comments-section').scrollIntoView({
            behavior: 'smooth'
        });
    });
</script>

{% endblock %}